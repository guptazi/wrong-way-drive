<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>BTS GeoData â€” API Endpoint Validator</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
--bg:#060a10;--panel:#0c1219;--card:#111a24;--card-h:#14202d;
--input:#0a1017;--border:#1a2736;--border-h:#253a50;
--t1:#e8ecf2;--t2:#8fa3bd;--t3:#4a6480;--t4:#2a3e55;
--blue:#4d8df5;--red:#f25555;--green:#3dd68c;--orange:#f59e0b;
--purple:#a97cf8;--cyan:#36c5e0;--yellow:#e4c54a;--pink:#e879a8;
--r:10px;--rs:6px;
}
html,body{height:100%;overflow:hidden}
body{font-family:'Outfit',system-ui,sans-serif;background:var(--bg);color:var(--t1);display:grid;grid-template-rows:auto 1fr;grid-template-columns:440px 1fr}

/* â•â•â• TOPBAR â•â•â• */
.topbar{grid-column:1/-1;background:var(--panel);border-bottom:1px solid var(--border);padding:0 24px;height:56px;display:flex;align-items:center;gap:16px;z-index:900}
.logo{display:flex;align-items:center;gap:11px;flex-shrink:0}
.logo-glyph{width:34px;height:34px;border-radius:9px;background:linear-gradient(135deg,#4d8df5 0%,#a97cf8 50%,#f25555 100%);display:flex;align-items:center;justify-content:center;font-size:17px;box-shadow:0 2px 12px rgba(77,141,245,.25)}
.logo h1{font-size:15px;font-weight:700;letter-spacing:-.4px;line-height:1.15}
.logo h1 small{display:block;font-size:10px;font-weight:400;color:var(--t3);letter-spacing:.3px;margin-top:1px}
.topbar-mid{flex:1;display:flex;align-items:center;justify-content:center}
.summary-pill{display:flex;align-items:center;gap:8px;padding:6px 16px;border-radius:20px;font-size:12px;font-weight:600;border:1px solid var(--border);background:var(--card);transition:all .4s}
.summary-pill .indicator{width:8px;height:8px;border-radius:50%;background:var(--t4);transition:background .4s,box-shadow .4s}
.summary-pill.all-ok .indicator{background:var(--green);box-shadow:0 0 8px rgba(61,214,140,.5)}
.summary-pill.partial .indicator{background:var(--yellow);box-shadow:0 0 8px rgba(228,197,74,.4)}
.summary-pill.none .indicator{background:var(--t4)}
.topbar-actions{display:flex;gap:8px;flex-shrink:0}
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border:none;border-radius:var(--rs);font-family:inherit;font-size:12px;font-weight:600;cursor:pointer;transition:all .18s;letter-spacing:.2px}
.btn:active{transform:scale(.97)}
.btn-accent{background:linear-gradient(135deg,#4d8df5,#6d6df5);color:#fff;box-shadow:0 2px 12px rgba(77,141,245,.2)}
.btn-accent:hover{box-shadow:0 4px 20px rgba(77,141,245,.35);transform:translateY(-1px)}
.btn-ghost{background:transparent;color:var(--t2);border:1px solid var(--border)}
.btn-ghost:hover{border-color:var(--t3);color:var(--t1)}
.btn-sm{padding:5px 10px;font-size:11px}
.btn-xs{padding:3px 7px;font-size:10px;border-radius:4px}

/* â•â•â• SIDEBAR â•â•â• */
.sidebar{background:var(--panel);border-right:1px solid var(--border);overflow-y:auto;overflow-x:hidden}
.sidebar::-webkit-scrollbar{width:4px}
.sidebar::-webkit-scrollbar-thumb{background:var(--border);border-radius:10px}

/* bbox controls */
.bbox-ctrl{padding:14px 18px;border-bottom:1px solid var(--border);background:rgba(77,141,245,.03)}
.bbox-label{font-size:10px;font-weight:600;color:var(--t3);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
.bbox-grid{display:grid;grid-template-columns:1fr auto 1fr auto 1fr auto 1fr;gap:4px;align-items:center}
.bbox-grid input{background:var(--input);border:1px solid var(--border);border-radius:4px;padding:5px 6px;font-family:'Space Mono',monospace;font-size:10px;color:var(--t1);outline:none;width:100%;text-align:center}
.bbox-grid input:focus{border-color:var(--blue);box-shadow:0 0 0 2px rgba(77,141,245,.15)}
.bbox-grid .sep{color:var(--t4);font-size:10px;text-align:center;font-family:'Space Mono',monospace}
.bbox-labels{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:4px;margin-bottom:4px}
.bbox-labels span{font-size:8px;color:var(--t4);text-align:center;text-transform:uppercase;letter-spacing:.5px}
.presets{display:flex;gap:4px;margin-top:8px;flex-wrap:wrap}
.preset{padding:3px 9px;border-radius:12px;font-size:10px;font-weight:500;border:1px solid var(--border);background:transparent;color:var(--t3);cursor:pointer;transition:all .15s}
.preset:hover,.preset.on{border-color:var(--blue);color:var(--blue);background:rgba(77,141,245,.06)}

/* dataset card */
.ds-card{padding:14px 18px;border-bottom:1px solid var(--border);transition:background .2s}
.ds-card:hover{background:var(--card-h)}
.ds-head{display:flex;align-items:flex-start;gap:10px}
.ds-swatch{width:4px;border-radius:2px;align-self:stretch;flex-shrink:0;min-height:36px}
.ds-titles{flex:1;min-width:0}
.ds-name{font-size:13px;font-weight:700;letter-spacing:-.2px}
.ds-desc{font-size:11px;color:var(--t3);line-height:1.45;margin-top:2px}
.ds-url-wrap{margin-top:8px;position:relative}
.ds-url{background:var(--input);border:1px solid var(--border);border-radius:var(--rs);padding:7px 9px;font-family:'Space Mono',monospace;font-size:9px;color:var(--t3);word-break:break-all;line-height:1.55;display:block;transition:border-color .2s;cursor:pointer}
.ds-url:hover{border-color:var(--blue);color:var(--t2)}
.ds-url-actions{position:absolute;top:4px;right:4px;display:flex;gap:3px;opacity:0;transition:opacity .15s}
.ds-url-wrap:hover .ds-url-actions{opacity:1}
.ds-row{display:flex;align-items:center;gap:8px;margin-top:8px}
.ds-status{flex:1;display:flex;align-items:center;gap:6px;font-size:11px;font-weight:500;color:var(--t3);min-height:26px}
.ds-status .dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.st-idle{background:var(--t4)}
.st-load{background:var(--yellow);animation:blink 1s ease infinite}
.st-ok{background:var(--green);box-shadow:0 0 6px rgba(61,214,140,.5)}
.st-err{background:var(--red);box-shadow:0 0 6px rgba(242,85,85,.5)}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.25}}
.ds-toggle{display:flex;align-items:center;gap:5px;font-size:11px;font-weight:500;color:var(--t3);cursor:pointer;user-select:none}
.ds-toggle:hover{color:var(--t2)}
.ds-toggle input{accent-color:var(--blue);width:14px;height:14px;cursor:pointer}
.ds-toggle.off{opacity:.3;pointer-events:none}
.ds-badge{font-family:'Space Mono',monospace;font-size:10px;padding:2px 7px;border-radius:4px;background:rgba(77,141,245,.08);color:var(--blue);border:1px solid rgba(77,141,245,.15)}

/* â•â•â• MAP â•â•â• */
.map-area{position:relative}
#map{width:100%;height:100%;background:var(--bg)}
.leaflet-popup-content-wrapper{background:var(--card)!important;color:var(--t1)!important;border:1px solid var(--border)!important;border-radius:var(--r)!important;box-shadow:0 12px 48px rgba(0,0,0,.6)!important;font-family:'Outfit',sans-serif!important}
.leaflet-popup-content{margin:10px 14px!important;font-size:12px!important;line-height:1.5!important}
.leaflet-popup-tip{background:var(--card)!important;border:1px solid var(--border)!important}
.pop-title{font-weight:700;font-size:13px;margin-bottom:6px;display:flex;align-items:center;gap:6px;line-height:1.3}
.pop-row{display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid rgba(255,255,255,.04);gap:12px}
.pop-row:last-child{border:none}
.pop-k{color:var(--t3);font-size:9px;text-transform:uppercase;letter-spacing:.5px;flex-shrink:0;padding-top:1px}
.pop-v{font-family:'Space Mono',monospace;font-size:10px;color:var(--t2);text-align:right;word-break:break-word}
.map-legend{position:absolute;bottom:24px;right:12px;z-index:800;background:var(--panel);border:1px solid var(--border);border-radius:var(--r);padding:10px 14px;font-size:11px}
.map-legend h4{font-size:9px;text-transform:uppercase;letter-spacing:.8px;color:var(--t3);margin-bottom:6px}
.legend-row{display:flex;align-items:center;gap:7px;padding:2px 0}
.legend-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0}
.legend-label{color:var(--t2);font-size:10px}

/* loading overlay */
.overlay{position:absolute;inset:0;background:rgba(6,10,16,.75);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:850;opacity:0;pointer-events:none;transition:opacity .3s}
.overlay.on{opacity:1;pointer-events:all}
.spin{width:34px;height:34px;border:3px solid var(--border);border-top-color:var(--blue);border-radius:50%;animation:spin .7s linear infinite;margin-bottom:8px}
@keyframes spin{to{transform:rotate(360deg)}}
.overlay p{font-size:12px;color:var(--t2)}

/* â•â•â• MOBILE â•â•â• */
.mob-toggle{display:none;position:fixed;bottom:16px;left:16px;z-index:1100;width:46px;height:46px;border-radius:50%;background:var(--blue);color:#fff;border:none;font-size:18px;cursor:pointer;box-shadow:0 4px 20px rgba(77,141,245,.4);transition:transform .2s}
.mob-toggle:active{transform:scale(.92)}
.mob-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:999}
@media(max-width:920px){
  body{grid-template-columns:1fr}
  .sidebar{position:fixed;left:0;top:0;bottom:0;width:min(400px,85vw);z-index:1050;transform:translateX(-100%);transition:transform .3s cubic-bezier(.4,0,.2,1)}
  .sidebar.open{transform:translateX(0)}
  .mob-toggle{display:flex;align-items:center;justify-content:center}
  .mob-backdrop.on{display:block;z-index:1040}
  .topbar{padding:0 14px}
  .topbar-mid{display:none}
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â• TOPBAR â•â•â•â•â•â•â• -->
<header class="topbar">
  <div class="logo">
    <div class="logo-glyph">ğŸ›°</div>
    <h1>BTS GeoData Validator<small>ArcGIS FeatureServer Endpoint Tester â€” geodata.bts.gov</small></h1>
  </div>
  <div class="topbar-mid">
    <div class="summary-pill none" id="pill">
      <span class="indicator"></span>
      <span id="pillText">0 of 6 endpoints tested</span>
    </div>
  </div>
  <div class="topbar-actions">
    <button class="btn btn-accent" onclick="testAll()">âš¡ Test All</button>
    <button class="btn btn-ghost" onclick="clearMap()">âœ• Clear Map</button>
  </div>
</header>

<!-- â•â•â•â•â•â•â• SIDEBAR â•â•â•â•â•â•â• -->
<aside class="sidebar" id="sidebar">
  <div class="bbox-ctrl">
    <div class="bbox-label">Bounding Box â€” WGS 84 Envelope</div>
    <div class="bbox-labels"><span>West</span><span>South</span><span>East</span><span>North</span></div>
    <div class="bbox-grid">
      <input id="bW" type="number" step=".01" value="-105.1">
      <span class="sep">,</span>
      <input id="bS" type="number" step=".01" value="39.3">
      <span class="sep">,</span>
      <input id="bE" type="number" step=".01" value="-104.6">
      <span class="sep">,</span>
      <input id="bN" type="number" step=".01" value="39.7">
    </div>
    <div class="presets">
      <button class="preset on" onclick="applyPreset(this,-105.1,39.3,-104.6,39.7)">Douglas Co, CO</button>
      <button class="preset" onclick="applyPreset(this,-77.6,37.45,-77.3,37.65)">Henrico Co, VA</button>
      <button class="preset" onclick="applyPreset(this,-77.15,38.79,-76.9,38.99)">Washington DC</button>
      <button class="preset" onclick="applyPreset(this,-122.52,37.7,-122.35,37.82)">San Francisco</button>
      <button class="preset" onclick="applyPreset(this,-74.02,40.7,-73.9,40.78)">Manhattan, NYC</button>
      <button class="preset" onclick="applyPreset(this,-87.75,41.82,-87.6,41.92)">Chicago</button>
    </div>
  </div>
  <div id="cards"></div>
</aside>

<!-- â•â•â•â•â•â•â• MAP â•â•â•â•â•â•â• -->
<main class="map-area">
  <div id="map"></div>
  <div class="overlay" id="overlay"><div class="spin"></div><p id="overlayMsg">Testing endpointsâ€¦</p></div>
  <div class="map-legend" id="legend" style="display:none">
    <h4>Active Layers</h4>
    <div id="legendRows"></div>
  </div>
</main>

<!-- MOBILE CONTROLS -->
<button class="mob-toggle" id="mobBtn" onclick="toggleSidebar()">â˜°</button>
<div class="mob-backdrop" id="mobDrop" onclick="toggleSidebar()"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATASET REGISTRY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DS = [
  {
    id:'nhpn', color:'#4d8df5',
    name:'HPMS â€” Natl Highway Planning Network',
    desc:'Road segments from HPMS submittals with AADT traffic volume, functional class, route signs, and NHS designation.',
    url:'https://services.arcgis.com/xOi1kZaI0eWDREZv/arcgis/rest/services/NTAD_National_Highway_Planning_Network/FeatureServer/0',
    geom:'line', queryMode:'envelope',
    popup(p){
      let h=ptitle('#4d8df5','ğŸ›£ï¸',p.SIGNT1&&p.SIGNN1?`${p.SIGNT1}-${p.SIGNN1}`:p.LNAME||'Road Segment');
      h+=maybe(p,'AADT','AADT',v=>Number(v).toLocaleString());
      h+=maybe(p,'LNAME','Name');
      h+=maybe(p,'FCLASS','Func Class');
      h+=maybe(p,'SIGNT1','Sign Type');
      h+=maybe(p,'SIGNN1','Sign Route');
      h+=maybe(p,'NHS','NHS');
      h+=maybe(p,'MILES','Miles',v=>Number(v).toFixed(2));
      h+=maybe(p,'STFIPS','State FIPS');
      return h;
    }
  },
  {
    id:'nbi', color:'#f25555',
    name:'National Bridge Inventory',
    desc:'Bridge locations with deck/superstructure/substructure condition ratings, year built, ADT, and structure type.',
    url:'https://services.arcgis.com/xOi1kZaI0eWDREZv/arcgis/rest/services/NTAD_National_Bridge_Inventory/FeatureServer/0',
    geom:'point', queryMode:'envelope',
    popup(p){
      const name=p.FEATURES_DESC_006A||p.FACILITY_CARRIED_007||p.STRUCTURE_NUMBER_008||'Bridge';
      let h=ptitle('#f25555','ğŸŒ‰',name);
      h+=maybe(p,'FACILITY_CARRIED_007','Facility');
      h+=maybe(p,'FEATURES_DESC_006A','Feature Crossed');
      h+=maybe(p,'DECK_COND_058','Deck Cond',condLabel);
      h+=maybe(p,'SUPERSTRUCTURE_COND_059','Superstr',condLabel);
      h+=maybe(p,'SUBSTRUCTURE_COND_060','Substr',condLabel);
      h+=maybe(p,'YEAR_BUILT_027','Year Built');
      h+=maybe(p,'ADT_029','ADT',v=>Number(v).toLocaleString());
      h+=maybe(p,'STRUCTURE_LEN_MT_049','Length (m)',v=>Number(v).toFixed(1));
      h+=maybe(p,'OWNER_022','Owner Code');
      return h;
    }
  },
  {
    id:'ntm_stops', color:'#3dd68c',
    name:'National Transit Map â€” Stops',
    desc:'Fixed-route transit stops from GTFS Schedule data â€” bus, rail, ferry pickup/dropoff locations.',
    url:'https://services.arcgis.com/xOi1kZaI0eWDREZv/arcgis/rest/services/NTAD_National_Transit_Map_Stops/FeatureServer/0',
    geom:'point', queryMode:'latlon', latField:'stop_lat', lonField:'stop_lon',
    popup(p){
      let h=ptitle('#3dd68c','ğŸš',p.stop_name||'Transit Stop');
      h+=maybe(p,'stop_type_text','Mode/Type');
      h+=maybe(p,'ntd_id','NTD ID');
      h+=maybe(p,'stop_id','Stop ID');
      h+=maybe(p,'stop_desc','Description');
      h+=maybe(p,'wheelchair_boarding','Wheelchair',v=>v==='1'?'âœ… Yes':v==='2'?'âŒ No':'Unknown');
      h+=maybe(p,'zone_id','Zone');
      if(p.stop_lat!=null) h+=prow('Coords',`${(+p.stop_lat).toFixed(5)}, ${(+p.stop_lon).toFixed(5)}`);
      return h;
    }
  },
  {
    id:'ntm_routes', color:'#f59e0b',
    name:'National Transit Map â€” Routes',
    desc:'Fixed-route transit service alignments â€” route shapes from GTFS with agency, mode, and route type.',
    url:'https://services.arcgis.com/xOi1kZaI0eWDREZv/arcgis/rest/services/NTAD_National_Transit_Map_Routes/FeatureServer/0',
    geom:'line', queryMode:'envelope',
    popup(p){
      let h=ptitle('#f59e0b','ğŸšŒ',p.route_long_name||p.route_short_name||'Transit Route');
      h+=maybe(p,'route_short_name','Short Name');
      h+=maybe(p,'route_long_name','Long Name');
      h+=maybe(p,'route_type_text','Mode');
      h+=maybe(p,'agency_name','Agency');
      h+=maybe(p,'ntd_id','NTD ID');
      h+=maybe(p,'feed_id','Feed ID');
      return h;
    }
  },
  {
    id:'rrgc', color:'#36c5e0',
    name:'Railroad Grade Crossings',
    desc:'Highway-rail crossing locations from the Natl Highway-Rail Crossing Inventory â€” crossing type, warning devices, rail traffic.',
    url:'https://services.arcgis.com/xOi1kZaI0eWDREZv/arcgis/rest/services/NTAD_Railroad_Grade_Crossings/FeatureServer/0',
    geom:'point', queryMode:'envelope',
    popup(p){
      const name=p.STREET||p.HIGHWAY||p.RAILROAD||'Grade Crossing';
      let h=ptitle('#36c5e0','ğŸš‚',name);
      h+=maybe(p,'STREET','Street');
      h+=maybe(p,'HIGHWAY','Highway');
      h+=maybe(p,'RAILROAD','Railroad');
      h+=maybe(p,'CROSSING','Crossing ID');
      h+=maybe(p,'CITY','City');
      h+=maybe(p,'STATE','State');
      h+=maybe(p,'TYPEXING','Crossing Type');
      h+=maybe(p,'POSXING','Position');
      h+=maybe(p,'WDCODE','Warning Device');
      h+=maybe(p,'TTSTN','Total Trains/Day');
      h+=maybe(p,'APTS','Auto Crashes (5yr)');
      return h;
    }
  },
  {
    id:'mpo', color:'#a97cf8',
    name:'Metropolitan Planning Organizations',
    desc:'MPO boundary polygons with names, designation dates, states, and population served.',
    url:'https://services.arcgis.com/xOi1kZaI0eWDREZv/arcgis/rest/services/NTAD_Metropolitan_Planning_Organizations/FeatureServer/0',
    geom:'polygon', queryMode:'envelope',
    popup(p){
      const name=p.MPO_NAME||p.NAME||p.MPO_name||'MPO';
      let h=ptitle('#a97cf8','ğŸ›ï¸',name);
      // Try various field name patterns
      h+=maybe(p,'MPO_NAME','Name')||maybe(p,'NAME','Name');
      h+=maybe(p,'STATE','State')||maybe(p,'STATES','States');
      h+=maybe(p,'POP','Population',v=>Number(v).toLocaleString());
      h+=maybe(p,'POPULATION','Population',v=>Number(v).toLocaleString());
      h+=maybe(p,'DESIGNATION_DATE','Designated');
      h+=maybe(p,'MPO_ID','MPO ID');
      h+=maybe(p,'WEBSITE','Website');
      return h;
    }
  }
];

// â”€â”€â”€ popup helpers â”€â”€â”€
function ptitle(c,icon,txt){ return `<div class="pop-title" style="color:${c}">${icon} ${esc(txt)}</div>`; }
function prow(k,v){ return `<div class="pop-row"><span class="pop-k">${esc(k)}</span><span class="pop-v">${v}</span></div>`; }
function maybe(p,field,label,fn){
  const v=p[field]; if(v==null||v==='') return '';
  return prow(label, esc(fn?fn(v):String(v)));
}
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function condLabel(v){
  const n=parseInt(v); if(isNaN(n)) return v;
  const labels={9:'Excellent',8:'Very Good',7:'Good',6:'Satisfactory',5:'Fair',4:'Poor',3:'Serious',2:'Critical',1:'Imminent Fail',0:'Failed'};
  return `${n} â€” ${labels[n]||'N/A'}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const st={};
DS.forEach(d=>{ st[d.id]={status:'idle',data:null,layer:null,shown:false,ms:null,count:null,err:null,pages:0}; });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const map=L.map('map',{center:[39.5,-104.85],zoom:10,zoomControl:true,attributionControl:true});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'Â© <a href="https://openstreetmap.org/copyright">OSM</a> Â· Data: <a href="https://geodata.bts.gov">BTS/USDOT NTAD</a>',
  maxZoom:19
}).addTo(map);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){
  const box=document.getElementById('cards');
  box.innerHTML=DS.map(d=>{
    const s=st[d.id];
    const dotCls=s.status==='ok'?'st-ok':s.status==='error'?'st-err':s.status==='loading'?'st-load':'st-idle';
    let statusTxt='Ready to test';
    if(s.status==='loading'){
      if(s.count>0) statusTxt=`Fetchingâ€¦ ${s.count.toLocaleString()} features (page ${s.pages||1})`;
      else statusTxt='Querying endpointâ€¦';
    }
    else if(s.status==='ok') statusTxt=`âœ“ ${s.count.toLocaleString()} feature${s.count!==1?'s':''} returned${s.pages>1?' ('+s.pages+' pages)':''}`;
    else if(s.status==='error') statusTxt=`âœ— ${s.err}`;
    const canShow=s.status==='ok'&&s.count>0;
    return `
    <div class="ds-card">
      <div class="ds-head">
        <div class="ds-swatch" style="background:${d.color}"></div>
        <div class="ds-titles">
          <div class="ds-name">${d.name}</div>
          <div class="ds-desc">${d.desc}</div>
        </div>
      </div>
      <div class="ds-url-wrap">
        <code class="ds-url" onclick="copyUrl('${d.id}')" title="Click to copy endpoint URL">${d.url}/query</code>
        <div class="ds-url-actions">
          <button class="btn btn-xs btn-ghost" onclick="copyUrl('${d.id}')">Copy</button>
          <button class="btn btn-xs btn-ghost" onclick="openUrl('${d.id}')">Open â†—</button>
        </div>
      </div>
      <div class="ds-row">
        <button class="btn btn-sm btn-accent" onclick="testOne('${d.id}')" ${s.status==='loading'?'disabled':''}>
          ${s.status==='loading'?'â³ Testingâ€¦':'â–¶ Test Endpoint'}
        </button>
        <div class="ds-status"><div class="dot ${dotCls}"></div><span>${statusTxt}</span></div>
      </div>
      <div class="ds-row">
        <label class="ds-toggle ${canShow?'':'off'}">
          <input type="checkbox" ${s.shown?'checked':''} onchange="toggleLayer('${d.id}',this.checked)" ${canShow?'':'disabled'}>
          Show on Map
        </label>
        ${canShow?`<button class="btn btn-xs btn-ghost" onclick="zoomLayer('${d.id}')">ğŸ“ Zoom</button>`:''}
        ${s.ms!=null?`<span class="ds-badge">${s.ms} ms</span>`:''}
      </div>
    </div>`;
  }).join('');
  updatePill();
  updateLegend();
}
render();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BBOX
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function bbox(){
  return {w:+document.getElementById('bW').value,s:+document.getElementById('bS').value,e:+document.getElementById('bE').value,n:+document.getElementById('bN').value};
}
function applyPreset(btn,w,s,e,n){
  document.getElementById('bW').value=w; document.getElementById('bS').value=s;
  document.getElementById('bE').value=e; document.getElementById('bN').value=n;
  document.querySelectorAll('.preset').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  map.fitBounds([[s,w],[n,e]],{padding:[30,30]});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BUILD QUERY URL (supports pagination via offset)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PAGE_SIZE = 2000; // ArcGIS max per request

function buildPageUrl(ds, bb, offset=0){
  const base=ds.url+'/query';

  if(ds.queryMode==='latlon'){
    const where=`${ds.lonField}>=${bb.w} AND ${ds.lonField}<=${bb.e} AND ${ds.latField}>=${bb.s} AND ${ds.latField}<=${bb.n}`;
    return base+'?'+[
      'where='+encodeURIComponent(where),
      'outFields=*','outSR=4326','returnGeometry=true',
      'resultRecordCount='+PAGE_SIZE,
      'resultOffset='+offset,
      'f=geojson'
    ].join('&');
  }

  const env=JSON.stringify({xmin:bb.w,ymin:bb.s,xmax:bb.e,ymax:bb.n,spatialReference:{wkid:4326}});
  return base+'?'+[
    'where='+encodeURIComponent('1=1'),
    'geometry='+encodeURIComponent(env),
    'geometryType=esriGeometryEnvelope',
    'spatialRel=esriSpatialRelIntersects',
    'inSR=4326','outFields=*','outSR=4326','returnGeometry=true',
    'resultRecordCount='+PAGE_SIZE,
    'resultOffset='+offset,
    'f=geojson'
  ].join('&');
}

// Fallback: simple where=1=1 (no spatial filter) to validate endpoint is live
function buildFallbackUrl(ds){
  return ds.url+'/query?where=1%3D1&outFields=*&outSR=4326&returnGeometry=true&resultRecordCount=10&f=geojson';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TEST ONE ENDPOINT â€” paginated fetch of ALL records
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function testOne(id){
  const ds=DS.find(d=>d.id===id);
  const s=st[id];
  const bb=bbox();

  // clear old layer
  if(s.layer){map.removeLayer(s.layer);s.layer=null;s.shown=false;}
  s.status='loading';s.err=null;s.data=null;s.count=null;s.ms=null;s.pages=0;
  render();

  const t0=performance.now();
  let allFeatures=[];
  let offset=0;
  let pages=0;

  try {
    while(true){
      const url=buildPageUrl(ds,bb,offset);
      const ctrl=new AbortController();
      const timer=setTimeout(()=>ctrl.abort(),30000);
      const res=await fetch(url,{signal:ctrl.signal});
      clearTimeout(timer);

      if(!res.ok) throw new Error('HTTP '+res.status);
      const json=await res.json();

      if(json.error){
        // On first page error, try fallback to validate endpoint
        if(pages===0){
          const fb=await tryFallback(ds);
          if(fb){
            allFeatures=fb.features||[];
            break;
          }
        }
        throw new Error(json.error.message||'Service error');
      }

      const features=json.features||[];
      allFeatures=allFeatures.concat(features);
      pages++;

      // Live progress update
      s.count=allFeatures.length;
      s.pages=pages;
      s.ms=Math.round(performance.now()-t0);
      render();

      // If we got fewer than PAGE_SIZE, we've got everything
      // Also check exceededTransferLimit flag
      if(features.length < PAGE_SIZE && !json.exceededTransferLimit){
        break;
      }

      // Safety cap: 50 pages = 100,000 features max
      if(pages >= 50){
        break;
      }

      offset += features.length;
    }

    // Build combined GeoJSON
    s.data={type:'FeatureCollection',features:allFeatures};
    s.status='ok';
    s.count=allFeatures.length;
    s.ms=Math.round(performance.now()-t0);

  } catch(err){
    s.ms=Math.round(performance.now()-t0);

    // If we already got some features, treat as partial success
    if(allFeatures.length>0){
      s.data={type:'FeatureCollection',features:allFeatures};
      s.status='ok';
      s.count=allFeatures.length;
      s.err=null;
      render();
      return;
    }

    // On network failure, try fallback
    if(err.message==='Failed to fetch'||err.name==='AbortError'){
      try {
        const fb=await tryFallback(ds);
        if(fb){
          s.status='ok'; s.count=fb.features?.length||0; s.data=fb;
          s.ms=Math.round(performance.now()-t0); s.err=null;
          render(); return;
        }
      } catch(e2){}
    }

    s.status='error';
    s.err=err.name==='AbortError'?'Timeout (30s)':err.message==='Failed to fetch'?'Network/CORS error â€” try opening URL directly':err.message;
  }
  render();
}

async function tryFallback(ds){
  try{
    const ctrl=new AbortController();
    const t=setTimeout(()=>ctrl.abort(),15000);
    const r=await fetch(buildFallbackUrl(ds),{signal:ctrl.signal});
    clearTimeout(t);
    if(!r.ok) return null;
    const j=await r.json();
    if(j.error) return null;
    return j;
  }catch(e){return null;}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TEST ALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function testAll(){
  document.getElementById('overlay').classList.add('on');
  document.getElementById('overlayMsg').textContent='Fetching all records from 6 endpointsâ€¦';
  await Promise.all(DS.map(d=>testOne(d.id)));
  document.getElementById('overlay').classList.remove('on');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAP LAYER TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleLayer(id,show){
  const ds=DS.find(d=>d.id===id);
  const s=st[id];
  if(s.layer){map.removeLayer(s.layer);s.layer=null;}

  if(show&&s.data){
    const layer=L.geoJSON(s.data,{
      pointToLayer:(f,ll)=>L.circleMarker(ll,{radius:6,fillColor:ds.color,fillOpacity:.85,color:'#fff',weight:1.5,opacity:.9}),
      style:f=>{
        if(ds.geom==='line') return {color:ds.color,weight:3,opacity:.8};
        if(ds.geom==='polygon') return {color:ds.color,weight:2,opacity:.85,fillColor:ds.color,fillOpacity:.1,dashArray:'6 3'};
        return {};
      },
      onEachFeature:(feature,layer)=>{
        try{layer.bindPopup(ds.popup(feature.properties||{}),{maxWidth:340});}catch(e){}
      }
    });
    layer.addTo(map);
    s.layer=layer; s.shown=true;
  } else {
    s.shown=false;
  }
  render();
}

function zoomLayer(id){
  const s=st[id];
  if(s.layer){try{map.fitBounds(s.layer.getBounds(),{padding:[50,50]});}catch(e){}}
}

function clearMap(){
  DS.forEach(d=>{const s=st[d.id];if(s.layer){map.removeLayer(s.layer);s.layer=null;}s.shown=false;});
  render();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUMMARY PILL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updatePill(){
  const tested=DS.filter(d=>st[d.id].status==='ok'||st[d.id].status==='error').length;
  const ok=DS.filter(d=>st[d.id].status==='ok').length;
  const pill=document.getElementById('pill');
  const txt=document.getElementById('pillText');
  if(tested===0){
    txt.textContent='0 of 6 endpoints tested';
    pill.className='summary-pill none';
  } else {
    txt.textContent=`${ok} of 6 endpoints responding`;
    pill.className='summary-pill '+(ok===6?'all-ok':ok>0?'partial':'none');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LEGEND
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateLegend(){
  const active=DS.filter(d=>st[d.id].shown);
  const leg=document.getElementById('legend');
  const rows=document.getElementById('legendRows');
  if(active.length===0){leg.style.display='none';return;}
  leg.style.display='block';
  rows.innerHTML=active.map(d=>`
    <div class="legend-row">
      <div class="legend-dot" style="background:${d.color}"></div>
      <span class="legend-label">${d.name.split('â€”')[0].trim()}</span>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function copyUrl(id){
  const ds=DS.find(d=>d.id===id);
  navigator.clipboard.writeText(ds.url+'/query').then(()=>{});
}
function openUrl(id){
  const ds=DS.find(d=>d.id===id);
  const bb=bbox();
  window.open(buildPageUrl(ds,bb,0),'_blank');
}
function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('mobDrop').classList.toggle('on');
}

// Initial zoom
map.fitBounds([[39.3,-105.1],[39.7,-104.6]],{padding:[30,30]});
</script>
</body>
</html>
